<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<title>FX Terminal v1.0</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

  :root {
    --green: #00ff41;
    --dim-green: #00aa2a;
    --dark-green: #003b00;
    --bg: #0a0a0a;
    --panel-bg: #0d1a0d;
    --border: #1a3a1a;
    --red: #ff3535;
    --dim-red: #aa2222;
    --cyan: #00e5ff;
    --gold: #ffd700;
    --grey: #5a7a5a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--green);
    font-family: 'Share Tech Mono', 'Courier New', monospace;
    min-height: 100vh;
    overflow-x: hidden;
    /* scanline overlay */
    background-image:
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.15) 2px,
        rgba(0,0,0,0.15) 4px
      );
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 18px 28px 14px;
    background: var(--panel-bg);
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 12px rgba(0,255,65,0.08);
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo {
    font-size: 1.55rem;
    letter-spacing: 3px;
    color: var(--green);
    text-shadow: 0 0 8px rgba(0,255,65,0.6);
  }
  .logo span { color: var(--cyan); }
  .version { font-size: 0.7rem; color: var(--grey); letter-spacing: 1px; }
  .status-bar { display: flex; align-items: center; gap: 18px; }
  .status-item { font-size: 0.72rem; color: var(--grey); letter-spacing: 0.5px; }
  .status-item .dot {
    display: inline-block; width: 7px; height: 7px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    margin-right: 5px;
    animation: pulse 2s infinite;
  }
  .dot.offline { background: var(--red); box-shadow: 0 0 6px var(--red); }
  @keyframes pulse {
    0%,100% { opacity:1; }
    50% { opacity:0.4; }
  }

  /* â”€â”€â”€ TOOLBAR â”€â”€â”€ */
  .toolbar {
    padding: 10px 28px;
    background: #0b150b;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .toolbar button {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--dim-green);
    font-family: inherit;
    font-size: 0.72rem;
    letter-spacing: 1.2px;
    padding: 5px 12px;
    cursor: pointer;
    transition: all .15s;
    text-transform: uppercase;
  }
  .toolbar button:hover, .toolbar button.active {
    border-color: var(--green);
    color: var(--green);
    box-shadow: 0 0 8px rgba(0,255,65,0.25);
  }
  .toolbar button.active { background: rgba(0,255,65,0.07); }
  .toolbar .sep { width: 1px; height: 18px; background: var(--border); }
  .toolbar input {
    background: #0a0a0a;
    border: 1px solid var(--border);
    color: var(--green);
    font-family: inherit;
    font-size: 0.75rem;
    padding: 5px 10px;
    width: 180px;
    outline: none;
  }
  .toolbar input::placeholder { color: var(--grey); }
  .toolbar input:focus { border-color: var(--green); box-shadow: 0 0 6px rgba(0,255,65,0.2); }

  /* â”€â”€â”€ BUNDLE CARDS â”€â”€â”€ */
  .bundles-bar {
    padding: 12px 28px;
    background: #0b150b;
    border-bottom: 1px solid var(--border);
    display: flex; gap: 10px; overflow-x: auto;
    scrollbar-width: none;
  }
  .bundles-bar::-webkit-scrollbar { display: none; }

  .bundle-card {
    flex-shrink: 0;
    min-width: 195px;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 14px;
    position: relative;
    transition: border-color .18s, box-shadow .18s;
    cursor: default;
  }
  .bundle-card:hover {
    border-color: var(--green);
    box-shadow: 0 0 10px rgba(0,255,65,0.18);
  }

  .bundle-badge {
    position: absolute; top: -1px; right: 10px;
    font-size: 0.56rem; letter-spacing: 1.2px;
    padding: 2px 6px; border-radius: 0 0 3px 3px;
  }
  .badge-hot  { background: rgba(255,53,53,0.2);  color: var(--red);  border: 1px solid rgba(255,53,53,0.35); border-top: none; }
  .badge-top  { background: rgba(0,255,65,0.15);  color: var(--green); border: 1px solid rgba(0,255,65,0.3);  border-top: none; }
  .badge-safe { background: rgba(255,53,53,0.12); color: var(--red);   border: 1px solid rgba(255,53,53,0.25); border-top: none; }

  .bundle-pair {
    font-size: 0.82rem; color: var(--green); letter-spacing: 1px; margin-top: 4px;
  }
  .bundle-pair .arr { color: var(--grey); margin: 0 4px; }

  .bundle-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 6px;
  }
  .bundle-label { font-size: 0.62rem; color: var(--grey); letter-spacing: 0.8px; text-transform: uppercase; }
  .bundle-val   { font-size: 0.74rem; color: var(--dim-green); letter-spacing: 0.5px; }
  .bundle-val.profit { color: var(--green); }
  .bundle-val.loss   { color: var(--red);   }

  .bundle-commission {
    margin-top: 7px;
    padding-top: 6px;
    border-top: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
  }
  .bundle-commission .bundle-label { color: #4a6a4a; }
  .bundle-commission .bundle-val   { font-size: 0.7rem; color: var(--grey); }
  .bundle-net { color: var(--green) !important; font-size: 0.76rem !important; font-weight: 600; }
  .bundle-net.loss { color: var(--red) !important; }

  /* card tint by result */
  .card-profit { border-color: rgba(0,255,65,0.28) !important; }
  .card-loss   { border-color: rgba(255,53,53,0.28) !important; }
  .card-profit:hover { box-shadow: 0 0 12px rgba(0,255,65,0.28) !important; }
  .card-loss:hover   { box-shadow: 0 0 12px rgba(255,53,53,0.22) !important; }

  /* 3-leg step rows */
  .bundle-steps { margin-top: 8px; }
  .bundle-step {
    display: flex; align-items: baseline; gap: 6px;
    padding: 3px 0;
    border-bottom: 1px solid rgba(26,58,26,0.4);
  }
  .bundle-step:last-child { border-bottom: none; }
  .bundle-step-label { font-size: 0.62rem; color: var(--grey); flex-shrink: 0; width: 88px; letter-spacing: 0.4px; }
  .bundle-step-val   { font-size: 0.72rem; color: var(--dim-green); flex: 1; text-align: right; }
  .bundle-step-unit  { font-size: 0.6rem; color: var(--grey); margin-left: 3px; }
  .bundle-step-fee   { font-size: 0.56rem; color: #4a6a4a; flex-shrink: 0; }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  .main { padding: 22px 28px; max-width: 1100px; margin: 0 auto; }

  /* â”€â”€â”€ TABLE â”€â”€â”€ */
  .table-wrap {
    border: 1px solid var(--border);
    border-radius: 3px;
    overflow: hidden;
    background: var(--panel-bg);
    box-shadow: 0 4px 24px rgba(0,0,0,0.5);
  }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    background: #0b150b;
    color: var(--grey);
    font-size: 0.68rem;
    letter-spacing: 1.8px;
    text-transform: uppercase;
    padding: 10px 16px;
    text-align: right;
    border-bottom: 1px solid var(--border);
    font-weight: 400;
  }
  thead th:first-child { text-align: left; }
  tbody tr {
    border-bottom: 1px solid rgba(26,58,26,0.5);
    transition: background .12s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(0,255,65,0.04); }
  tbody td {
    padding: 11px 16px;
    font-size: 0.82rem;
    text-align: right;
    color: var(--dim-green);
  }
  tbody td:first-child { text-align: left; }

  .symbol { color: var(--green); font-weight: 600; letter-spacing: 1px; }
  .name { color: var(--grey); font-size: 0.68rem; letter-spacing: 0.5px; }
  .tag {
    font-size: 0.58rem; letter-spacing: 1px; padding: 1px 5px;
    border-radius: 2px; margin-left: 6px; vertical-align: middle;
  }
  .tag-fiat { background: rgba(0,229,255,0.12); color: var(--cyan); border: 1px solid rgba(0,229,255,0.25); }
  .tag-crypto { background: rgba(255,215,0,0.12); color: var(--gold); border: 1px solid rgba(255,215,0,0.25); }

  .up { color: var(--green) !important; }
  .down { color: var(--red) !important; }
  .arrow { margin-right: 3px; }

  /* flash on update */
  @keyframes flash-green {
    0% { background: rgba(0,255,65,0.18); }
    100% { background: transparent; }
  }
  @keyframes flash-red {
    0% { background: rgba(255,53,53,0.18); }
    100% { background: transparent; }
  }
  .flash-up { animation: flash-green .6s ease-out; }
  .flash-down { animation: flash-red .6s ease-out; }

  /* â”€â”€â”€ CONVERTER â”€â”€â”€ */
  .converter-panel {
    margin-top: 22px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--panel-bg);
    padding: 18px 22px;
    display: none;
  }
  .converter-panel.visible { display: block; }
  .converter-title { font-size: 0.7rem; letter-spacing: 1.5px; color: var(--grey); margin-bottom: 14px; text-transform: uppercase; }
  .converter-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .converter-row input, .converter-row select {
    background: #0a0a0a; border: 1px solid var(--border);
    color: var(--green); font-family: inherit; font-size: 0.82rem;
    padding: 7px 10px; outline: none;
  }
  .converter-row input { width: 130px; }
  .converter-row select { width: 100px; background-color: #0a0a0a; }
  .converter-row input:focus, .converter-row select:focus { border-color: var(--green); }
  .converter-row .eq { color: var(--grey); font-size: 0.78rem; }
  .converter-result { color: var(--green); font-size: 1rem; font-weight: 600; letter-spacing: 1px; }
  .converter-row select option { background: #111; color: var(--green); }

  /* â”€â”€â”€ LOG â”€â”€â”€ */
  .log-panel {
    margin-top: 22px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--panel-bg);
    padding: 14px 18px;
    max-height: 140px;
    overflow-y: auto;
    display: none;
  }
  .log-panel.visible { display: block; }
  .log-line { font-size: 0.7rem; color: var(--grey); padding: 1.5px 0; }
  .log-line .ts { color: var(--dark-green); margin-right: 8px; }
  .log-line .msg-ok { color: var(--dim-green); }
  .log-line .msg-err { color: var(--dim-red); }

  /* â”€â”€â”€ LOADING â”€â”€â”€ */
  .loading-row td { text-align: center !important; color: var(--grey); font-size: 0.75rem; letter-spacing: 2px; }
  @keyframes dots {
    0% { content: "."; }
    33% { content: ".."; }
    66% { content: "..."; }
  }
  .dots::after { content: "."; animation: dots 1s steps(1) infinite; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€â”€ iPHONE / MOBILE â”€â”€â”€ */
  @media (max-width: 480px) {

    /* safe area for notch / Dynamic Island */
    body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

    /* â”€â”€ header â”€â”€ */
    .header { padding: 10px 14px 8px; flex-direction: column; align-items: flex-start; gap: 4px; }
    .logo { font-size: 1.25rem; letter-spacing: 2px; }
    .version { font-size: 0.6rem; }
    .status-bar { gap: 12px; }
    .status-item { font-size: 0.64rem; }

    /* â”€â”€ toolbar â”€â”€ */
    .toolbar { padding: 8px 10px; gap: 6px; }
    .toolbar button { font-size: 0.68rem; padding: 6px 10px; letter-spacing: 0.8px; }
    .toolbar .sep { display: none; }                       /* hide separators */
    .toolbar input { width: 100%; order: 5; margin-top: 4px; font-size: 0.8rem; padding: 6px 10px; }  /* search goes full-width on 2nd row */

    /* â”€â”€ bundle cards â”€â”€ */
    .bundles-bar { padding: 10px 10px; gap: 8px; }
    .bundle-card { min-width: 158px; padding: 9px 10px 8px; }
    .bundle-pair { font-size: 0.75rem; margin-top: 2px; }
    .bundle-pair .arr { margin: 0 2px; }
    .bundle-badge { font-size: 0.5rem; padding: 1px 5px; right: 6px; }
    .bundle-step-label { width: 76px; font-size: 0.58rem; }
    .bundle-step-val { font-size: 0.66rem; }
    .bundle-step-fee { font-size: 0.52rem; }
    .bundle-label { font-size: 0.58rem; }
    .bundle-val { font-size: 0.68rem; }
    .bundle-net { font-size: 0.7rem !important; }
    .bundle-commission { margin-top: 5px; padding-top: 4px; }
    .bundle-row { margin-top: 4px; }

    /* â”€â”€ table â”€â”€ */
    .main { padding: 12px 10px; }
    thead th, tbody td { padding: 9px 7px; font-size: 0.72rem; letter-spacing: 0.6px; }
    thead th { font-size: 0.6rem; letter-spacing: 1px; }
    .symbol { font-size: 0.78rem; }
    .name { font-size: 0.6rem; }
    .tag { font-size: 0.5rem; padding: 1px 4px; margin-left: 3px; }

    /* hide HIGH 24H & LOW 24H columns on mobile */
    thead th:nth-child(4),
    thead th:nth-child(5),
    tbody td:nth-child(4),
    tbody td:nth-child(5) { display: none; }

    /* â”€â”€ converter â”€â”€ */
    .converter-panel { padding: 14px 12px; margin-top: 14px; }
    .converter-row { flex-direction: column; align-items: stretch; gap: 8px; }
    .converter-row input { width: 100%; font-size: 1rem; padding: 10px; }   /* bigger tap target */
    .converter-row select { width: 100%; font-size: 1rem; padding: 10px; }
    .converter-row .eq { text-align: center; font-size: 1.1rem; }
    .converter-result { text-align: center; font-size: 1.1rem; }
    .converter-title { font-size: 0.65rem; }

    /* â”€â”€ log â”€â”€ */
    .log-panel { padding: 10px 12px; margin-top: 14px; max-height: 110px; }
    .log-line { font-size: 0.64rem; }
  }

  /* â”€â”€ very small iPhones (SE / 12 mini) â”€â”€ */
  @media (max-width: 350px) {
    .bundle-card { min-width: 140px; padding: 8px 8px 7px; }
    .bundle-pair { font-size: 0.7rem; }
    .bundle-step-label { width: 68px; font-size: 0.54rem; }
    .bundle-step-val { font-size: 0.6rem; }
    thead th, tbody td { padding: 7px 5px; font-size: 0.66rem; }
    .toolbar button { font-size: 0.64rem; padding: 5px 8px; }
  }</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div class="logo">META<span>FLOW</span></div>
    <div class="version">v1.0 â€” WORLD EXCHANGE MONITOR by Lobster IN</div>
  </div>
  <div class="status-bar">
    <div class="status-item" id="statusConn"><span class="dot"></span>CONNECTED</div>
    <div class="status-item" id="statusTime">--:--:--</div>
  </div>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <button class="active" id="btnAll" onclick="setFilter('all')">ALL</button>
  <button id="btnFiat" onclick="setFilter('fiat')">FIAT</button>
  <button id="btnCrypto" onclick="setFilter('crypto')">CRYPTO</button>
  <div class="sep"></div>
  <input type="text" id="searchInput" placeholder="Search currencyâ€¦" oninput="renderTable()" />
  <div class="sep"></div>
  <button id="btnConvert" onclick="togglePanel('converter')">â‡„ CONVERT</button>
  <button id="btnLog" onclick="togglePanel('log')">âš™ LOG</button>
  <button onclick="fetchRates()">â†» REFRESH</button>
</div>

<!-- BUNDLE CARDS -->
<div class="bundles-bar" id="bundlesBar">
  <!-- populated by JS -->
</div>

<!-- MAIN -->
<div class="main">
  <table class="table-wrap">
    <thead>
      <tr>
        <th style="text-align:left">CURRENCY</th>
        <th>RATE (USD)</th>
        <th>CHANGE</th>
        <th>HIGH 24H</th>
        <th>LOW 24H</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr class="loading-row"><td colspan="5">INITIALIZING<span class="dots"></span></td></tr>
    </tbody>
  </table>

  <!-- CONVERTER -->
  <div class="converter-panel" id="converterPanel">
    <div class="converter-title">Â» CURRENCY CONVERTER</div>
    <div class="converter-row">
      <input type="number" id="convAmount" value="1" oninput="convert()" />
      <select id="convFrom" onchange="convert()"></select>
      <span class="eq">â•â•â•â–¶</span>
      <span class="converter-result" id="convResult">â€”</span>
      <select id="convTo" onchange="convert()"></select>
    </div>
  </div>

  <!-- LOG -->
  <div class="log-panel" id="logPanel">
    <div class="log-line"><span class="ts">[BOOT]</span><span class="msg-ok">FX Terminal initialised.</span></div>
  </div>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FIAT_CURRENCIES = [
  { code:'EUR', name:'Euro' },
  { code:'GBP', name:'British Pound' },
  { code:'JPY', name:'Japanese Yen' },
  { code:'CAD', name:'Canadian Dollar' },
  { code:'AUD', name:'Australian Dollar' },
  { code:'CHF', name:'Swiss Franc' },
  { code:'CNY', name:'Chinese Yuan' },
  { code:'INR', name:'Indian Rupee' },
  { code:'MXN', name:'Mexican Peso' },
  { code:'BRL', name:'Brazilian Real' },
  { code:'ZAR', name:'South African Rand' },
  { code:'SEK', name:'Swedish Krona' },
  { code:'NOK', name:'Norwegian Krone' },
  { code:'PLN', name:'Polish Zloty' },
  { code:'SGD', name:'Singapore Dollar' },
  { code:'HKD', name:'Hong Kong Dollar' },
  { code:'NZD', name:'New Zealand Dollar' },
  { code:'THB', name:'Thai Baht' },
  { code:'KRW', name:'South Korean Won' },
  { code:'TRY', name:'Turkish Lira' },
];

const CRYPTO_CURRENCIES = [
  { code:'btc', name:'Bitcoin' },
  { code:'eth', name:'Ethereum' },
  { code:'bnb', name:'Binance Coin' },
  { code:'sol', name:'Solana' },
  { code:'xrp', name:'XRP' },
  { code:'ada', name:'Cardano' },
  { code:'doge', name:'Dogecoin' },
  { code:'avax', name:'Avalanche' },
  { code:'link', name:'Chainlink' },
  { code:'dot', name:'Polkadot' },
  { code:'ltc', name:'Litecoin' },
  { code:'uni', name:'Uniswap' },
];

let ratesData = {};        // code â†’ { rate, prev }
let currentFilter = 'all';
let prevRates = {};        // stored for simulated prev (on first load we fake change)

// â”€â”€â”€ API (fawazahmed0 â€” free, no key) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_FIAT = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json';
const API_CRYPTO = (base) => `https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${base}.json`;

// â”€â”€â”€ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type='ok') {
  const panel = document.getElementById('logPanel');
  const ts = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class="ts">[${ts}]</span><span class="msg-${type}">${msg}</span>`;
  panel.appendChild(line);
  panel.scrollTop = panel.scrollHeight;
}

// â”€â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickClock() {
  document.getElementById('statusTime').textContent = new Date().toLocaleTimeString();
}
setInterval(tickClock, 1000);
tickClock();

// â”€â”€â”€ FILTER / SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f) {
  currentFilter = f;
  ['btnAll','btnFiat','btnCrypto'].forEach(id => document.getElementById(id).classList.remove('active'));
  document.getElementById('btn' + f.charAt(0).toUpperCase() + f.slice(1)).classList.add('active');
  renderTable();
}

function togglePanel(name) {
  const panel = document.getElementById(name === 'converter' ? 'converterPanel' : 'logPanel');
  panel.classList.toggle('visible');
}

// â”€â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchRates() {
  setStatus(true);
  log('Fetching fiat ratesâ€¦');
  try {
    const fiatRes = await fetch(API_FIAT);
    const fiatJson = await fiatRes.json();
    const fiatRates = fiatJson.usd; // { eur: 0.91, gbp: 0.78, â€¦ }

    log('Fiat OK. Fetching cryptoâ€¦');

    // We fetch crypto via USD base â€“ crypto codes are lowercase in this API
    // BTC: get usd rate from btc base â†’ 1 BTC = X USD
    const cryptoRes = await fetch(API_CRYPTO('btc'));
    const cryptoJson = await cryptoRes.json();
    const btcInUsd = 1 / cryptoJson.btc.usd; // invert

    // For other cryptos we grab from usd base (they are included)
    // Actually fawazahmed0 API includes crypto in the usd base too
    // Let's just re-use fiatRates which already has crypto codes
    log('Crypto OK. Renderingâ€¦');

    // Store prev before overwriting
    Object.keys(ratesData).forEach(k => { prevRates[k] = ratesData[k].rate; });

    // Build ratesData
    FIAT_CURRENCIES.forEach(c => {
      const code = c.code.toLowerCase();
      const raw = fiatRates[code];
      if (raw) {
        const rate = 1 / raw; // fiatRates is USDâ†’X, we want Xâ†’USD
        ratesData[c.code.toUpperCase()] = {
          rate,
          name: c.name,
          type: 'fiat',
          code: c.code.toUpperCase()
        };
      }
    });

    CRYPTO_CURRENCIES.forEach(c => {
      const code = c.code.toLowerCase();
      const raw = fiatRates[code];
      if (raw) {
        const rate = 1 / raw;
        ratesData[c.code.toUpperCase()] = {
          rate,
          name: c.name,
          type: 'crypto',
          code: c.code.toUpperCase()
        };
      }
    });

    // On first load, simulate tiny previous rate variance so change % shows
    if (Object.keys(prevRates).length === 0) {
      Object.keys(ratesData).forEach(k => {
        prevRates[k] = ratesData[k].rate * (1 + (Math.random() - 0.5) * 0.04);
      });
    }

    renderTable();
    renderBundles();
    populateConverterSelects();
    convert();
    log('All rates updated successfully.');
  } catch(e) {
    log('Fetch error: ' + e.message, 'err');
    setStatus(false);
  }
}

function setStatus(ok) {
  const el = document.getElementById('statusConn');
  el.innerHTML = ok
    ? '<span class="dot"></span>CONNECTED'
    : '<span class="dot offline"></span>OFFLINE';
}

// â”€â”€â”€ RENDER TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const body = document.getElementById('tableBody');
  const search = document.getElementById('searchInput').value.toLowerCase();
  let rows = '';
  let count = 0;

  // Gather & sort by rate desc
  const entries = Object.values(ratesData).sort((a,b) => b.rate - a.rate);

  entries.forEach(item => {
    if (currentFilter === 'fiat' && item.type !== 'fiat') return;
    if (currentFilter === 'crypto' && item.type !== 'crypto') return;
    if (search && !item.code.toLowerCase().includes(search) && !item.name.toLowerCase().includes(search)) return;

    const prev = prevRates[item.code];
    const pct = prev ? ((item.rate - prev) / prev) * 100 : 0;
    const isUp = pct >= 0;
    const cls = isUp ? 'up' : 'down';
    const arrow = isUp ? 'â–²' : 'â–¼';
    const tagCls = item.type === 'fiat' ? 'tag-fiat' : 'tag-crypto';
    const tagTxt = item.type === 'fiat' ? 'FIAT' : 'CRYPTO';

    // Simulated 24h high/low based on rate
    const hi = item.rate * (1 + Math.random() * 0.02);
    const lo = item.rate * (1 - Math.random() * 0.02);

    const fmtRate = item.code === 'JPY' || item.code === 'KRW'
      ? item.rate.toFixed(2)
      : item.rate < 0.001 ? item.rate.toExponential(4)
      : item.rate < 1 ? item.rate.toFixed(6)
      : item.rate.toFixed(4);

    rows += `
      <tr data-code="${item.code}" class="${isUp ? 'flash-up' : 'flash-down'}">
        <td>
          <span class="symbol">${item.code === 'BTC' || item.code === 'ETH' || item.code === 'SOL' || item.code === 'BNB' || item.code === 'XRP' || item.code === 'ADA' || item.code === 'DOGE' || item.code === 'AVAX' || item.code === 'LINK' || item.code === 'DOT' || item.code === 'LTC' || item.code === 'UNI' ? item.code : item.code}</span>
          <span class="tag ${tagCls}">${tagTxt}</span><br/>
          <span class="name">${item.name}</span>
        </td>
        <td style="font-size:0.88rem; color: var(--green); letter-spacing:0.5px;">${fmtRate}</td>
        <td class="${cls}"><span class="arrow">${arrow}</span>${Math.abs(pct).toFixed(2)}%</td>
        <td style="color: var(--dim-green);">${hi.toFixed(4)}</td>
        <td style="color: var(--dim-green);">${lo.toFixed(4)}</td>
      </tr>`;
    count++;
  });

  body.innerHTML = count > 0 ? rows : '<tr class="loading-row"><td colspan="5">NO RESULTS</td></tr>';
}

// â”€â”€â”€ CONVERTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateConverterSelects() {
  const codes = Object.keys(ratesData).sort();
  ['convFrom','convTo'].forEach(id => {
    const sel = document.getElementById(id);
    const prev = sel.value;
    sel.innerHTML = '<option value="USD">USD</option>' +
      codes.map(c => `<option value="${c}">${c}</option>`).join('');
    if (prev) sel.value = prev;
  });
  document.getElementById('convFrom').value = 'USD';
  document.getElementById('convTo').value = 'EUR';
}

function convert() {
  const amt = parseFloat(document.getElementById('convAmount').value) || 0;
  const from = document.getElementById('convFrom').value;
  const to = document.getElementById('convTo').value;

  // All rates are X per 1 USD.  To convert fromâ†’to:
  // 1. Convert 'from' to USD: usd = amt * rateFrom  (rateFrom = USD per 1 unit of from)
  // 2. Convert USD to 'to':   result = usd / rateTo

  let rateFrom = from === 'USD' ? 1 : (ratesData[from]?.rate || 1);
  let rateTo   = to   === 'USD' ? 1 : (ratesData[to]?.rate   || 1);

  const result = amt * rateFrom / rateTo;
  document.getElementById('convResult').textContent = result.toFixed(6) + ' ' + to;
}

// â”€â”€â”€ TRIANGULAR ARBITRAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each chain: USD â†’ A â†’ B â†’ USD.  We start with $1000 and run it through.
// Commission is charged at EVERY leg (realistic: exchange fees per swap).
// ratesData stores: 1 unit of X = rate USD.  So to convert USDâ†’X: divide.  Xâ†’USD: multiply.
//
// Leg math:
//   USD â†’ A :  amount_A = startUSD / rateA          (buy A with USD)
//   A   â†’ B :  amount_B = amount_A * rateA / rateB  (sell A, buy B â€” both via USD cross)
//   B   â†’ USD: endUSD   = amount_B * rateB          (sell B for USD)
// After commission at each leg: multiply by (1 - commission_leg)

const CHAINS = [
  { mid:'PLN',  last:'BTC', commissions:[0.001, 0.0015, 0.001]  },  // USDâ†’PLNâ†’BTCâ†’USD
  { mid:'EUR',  last:'ETH', commissions:[0.001, 0.001,  0.0015] },  // USDâ†’EURâ†’ETHâ†’USD
  { mid:'GBP',  last:'SOL', commissions:[0.001, 0.002,  0.0015] },  // USDâ†’GBPâ†’SOLâ†’USD
  { mid:'JPY',  last:'BNB', commissions:[0.0008,0.0015, 0.001]  },  // USDâ†’JPYâ†’BNBâ†’USD
  { mid:'CHF',  last:'ADA', commissions:[0.001, 0.002,  0.002]  },  // USDâ†’CHFâ†’ADAâ†’USD
  { mid:'CAD',  last:'DOGE',commissions:[0.0008,0.0015, 0.0015] },  // USDâ†’CADâ†’DOGEâ†’USD
  { mid:'AUD',  last:'LINK',commissions:[0.001, 0.002,  0.001]  },  // USDâ†’AUDâ†’LINKâ†’USD
  { mid:'SEK',  last:'DOT', commissions:[0.0012,0.002,  0.0015] },  // USDâ†’SEKâ†’DOTâ†’USD
];

// Returns { endUSD, profitPct, steps: [{label, amount, after_fee}] }
function calcChain(chain, startUSD) {
  const rA = ratesData[chain.mid]?.rate;
  const rB = ratesData[chain.last]?.rate;
  if (!rA || !rB) return null;

  const [c1, c2, c3] = chain.commissions;

  // Leg 1: USD â†’ mid   (buy mid with USD)
  const raw1   = startUSD / rA;           // how many units of mid we get
  const after1 = raw1 * (1 - c1);         // minus exchange fee

  // Leg 2: mid â†’ last  (sell mid, buy last â€” cross via USD internally)
  const raw2   = after1 * rA / rB;        // convert midâ†’last via their USD values
  const after2 = raw2 * (1 - c2);

  // Leg 3: last â†’ USD  (sell last back to USD)
  const raw3   = after2 * rB;             // back to USD
  const endUSD = raw3 * (1 - c3);

  const profitPct = ((endUSD - startUSD) / startUSD) * 100;

  return {
    endUSD,
    profitPct,
    steps: [
      { label:'USD â†’ ' + chain.mid,  amount: after1, unit: chain.mid,  fee: c1 },
      { label: chain.mid + ' â†’ ' + chain.last, amount: after2, unit: chain.last, fee: c2 },
      { label: chain.last + ' â†’ USD', amount: endUSD, unit: 'USD', fee: c3 },
    ]
  };
}

function renderBundles() {
  const bar = document.getElementById('bundlesBar');
  if (Object.keys(ratesData).length === 0) return;

  const START = 1000; // simulate starting with $1000

  // Calculate all, then sort by profitPct descending so best opportunities are first
  const results = CHAINS.map(chain => {
    const res = calcChain(chain, START);
    if (!res) return null;
    return { chain, ...res };
  }).filter(Boolean).sort((a, b) => b.profitPct - a.profitPct);

  bar.innerHTML = results.map(r => {
    const isProfit = r.profitPct >= 0;
    const sign     = isProfit ? '+' : 'âˆ’';
    const badge    = isProfit ? 'top' : 'safe';
    const badgeTxt = isProfit ? 'â­ PROFIT' : 'ğŸ“‰ LOSS';
    const totalComm = (r.chain.commissions.reduce((a,b) => a+b, 0) * 100).toFixed(2);
    const profitUSD = r.endUSD - START;

    // Build the 3-step chain visual
    const stepsHtml = r.steps.map((s, i) =>
      `<div class="bundle-step">
        <span class="bundle-step-label">${i+1}. ${s.label}</span>
        <span class="bundle-step-val">${s.amount < 0.0001 ? s.amount.toExponential(3) : s.amount.toFixed(4)} <span class="bundle-step-unit">${s.unit}</span></span>
        <span class="bundle-step-fee">fee ${(s.fee*100).toFixed(2)}%</span>
      </div>`
    ).join('');

    return `
      <div class="bundle-card ${isProfit ? 'card-profit' : 'card-loss'}">
        <div class="bundle-badge badge-${badge}">${badgeTxt}</div>
        <div class="bundle-pair">USD<span class="arr">â†’</span>${r.chain.mid}<span class="arr">â†’</span>${r.chain.last}<span class="arr">â†’</span>USD</div>
        <div class="bundle-steps">${stepsHtml}</div>
        <div class="bundle-commission">
          <span class="bundle-label">Total fees</span>
          <span class="bundle-val">âˆ’${totalComm}%</span>
        </div>
        <div class="bundle-row" style="margin-top:6px;">
          <span class="bundle-label">Start</span>
          <span class="bundle-val">\$${START.toFixed(2)}</span>
        </div>
        <div class="bundle-row">
          <span class="bundle-label">End</span>
          <span class="bundle-val">\$${r.endUSD.toFixed(2)}</span>
        </div>
        <div class="bundle-row">
          <span class="bundle-label">Net P/L</span>
          <span class="bundle-val bundle-net ${isProfit ? 'profit' : 'loss'}">${sign}\$${Math.abs(profitUSD).toFixed(2)} (${sign}${Math.abs(r.profitPct).toFixed(3)}%)</span>
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€ AUTO REFRESH every 60s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(fetchRates, 60000);

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log('Connecting to exchangeâ€¦');
fetchRates();
</script>
</body>
</html>
